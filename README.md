# stocks-server

Server for the stocks/news-to-tweet pipeline: fetches market news from Alpaca, Finnhub, and Alpha Vantage, sends a summary to an Ollama LLM (e.g. on a Raspberry Pi) to generate a tweet, and posts to X (Twitter). Tweets can promote [learnstockmarket.online](https://learnstockmarket.online) (chart patterns, trading strategies, lessons).

## Environment

1. Copy `.env.example` to `.env`.
2. Fill in all placeholders. Any new keys or config added in the repo must be added to `.env.example` with a placeholder and short comment.

Required for the tweet pipeline:

- **Alpaca:** `VITE_ALPACA_HISTORY_BASE_URL`, `VITE_ALPACA_API_KEY`, `VITE_ALPACA_SECRET_KEY` (news + data).
- **X (Twitter):** `X_API_KEY`, `X_API_SECRET`, `X_ACCESS_TOKEN`, `X_ACCESS_TOKEN_SECRET` (OAuth 1.0a for posting).
- **Ollama:** `OLLAMA_BASE_URL` (e.g. `http://<raspberry-pi-ip>:11434` or `http://localhost:11434` if the server runs on the same Pi), optional `OLLAMA_MODEL` (default `gemma2:2b`).
- **Finnhub:** `FINNHUB_API_KEY` (free at [finnhub.io](https://finnhub.io)).
- **Alpha Vantage:** `ALPHA_VANTAGE_API_KEY` (free at [alphavantage.co](https://www.alphavantage.co/support/#api-key)).
- **Promo:** `PROMO_WEBSITE_URL` (default `https://learnstockmarket.online`).

Optional:

- **DRY_RUN:** Set to `true` or `1` to run the pipeline without posting to X (test news fetch and LLM output only).
- **POST_START_DATE:** First date to post (YYYY-MM-DD). The job runs on schedule but skips posting before this date (e.g. `2025-02-18` to start on February 18th morning).

## Run once (single tweet)

```bash
npm run tweet
```

Or:

```bash
node src/jobs/tweet-job.js
```

To test without posting, set `DRY_RUN=true` in `.env` or run:

```bash
DRY_RUN=true npm run tweet
```

## Run 6 posts per day

Start the scheduler (runs the tweet job at 8:00, 10:00, 12:00, 14:00, 16:00, 18:00 in the server’s timezone):

```bash
npm run schedule
```

Or:

```bash
node src/scheduler.js
```

**Run with PM2 (recommended):**

```bash
npm run pm2:start
```

This starts the scheduler as a background process. Posting will begin on or after `POST_START_DATE` (see env). Logs: `npm run pm2:logs`. Stop: `npm run pm2:stop`.

You can also keep the process running with `npm run schedule` in a terminal, or use system cron to run `npm run tweet` 6 times per day at 8:00, 10:00, 12:00, 14:00, 16:00, 18:00.

## Chart pattern scan (Python + Node)

A separate job fetches daily OHLC bars from Alpaca for a configurable list of symbols, runs a Python script that detects chart patterns (e.g. head & shoulders, inverse head & shoulders), and prints JSON results. Suitable for overnight or scheduled runs.

**Single source of truth:** The master list of valid tickers is **`src/stocks.js`** (`STOCKS`). The pattern-scan job only uses symbols that appear in that list.

**Setup:**

1. **Stocks to scan:** Edit `config/stocks-to-scan.json`:
   - **Explicit list (default):** Set `symbols` to an array of tickers (e.g. `["AAPL", "MSFT", "SPY"]`). Only symbols that exist in `src/stocks.js` are used; others are ignored.
   - **Master list batch:** Set `"useMasterList": true` to scan from `STOCKS`. Optionally set `"limit": 100` to scan only the first 100 symbols (useful for overnight runs without hitting API limits).
2. **Python (3.10+):** From the project root:
   ```bash
   pip install -r python/requirements.txt
   ```
   Uses the `tradingpattern` package (pandas, numpy).

**Run once:**

```bash
npm run pattern-scan
```

This loads symbols from config, fetches the last 365 days of daily bars from Alpaca (same keys as the tweet pipeline), pipes OHLC JSON to `python/pattern_scan.py`, and prints `{ "results": [ { "symbol", "patterns": [ { "type", "date" } ] }, ... ], "errors": [] }`.

**Tests:**

- **Node:** `npm test` runs `node --test tests/`, including `tests/pattern-scan.test.js`, which runs the Python script with fixture OHLC and asserts the output shape. Requires Python 3 and `python/requirements.txt` installed.
- **Python:** After `pip install -r python/requirements.txt`, run `npm run test:python` (or `cd python && pytest tests/ -v`) to run `python/tests/test_pattern_scan.py`.

## Requirements

- Node.js 18+ (for native `fetch`).
- Ollama running on your Raspberry Pi (or the same machine) with a model such as `gemma2:2b`, reachable at `OLLAMA_BASE_URL`.
- For pattern scan: Python 3.10+ with dependencies in `python/requirements.txt`.

## What gets advertised

Tweets are generated by the LLM using market news and a fixed description of **learnstockmarket.online**:

- **/patterns** – Chart and technical patterns (support/resistance, trend patterns).
- **/strategies** – Trading strategies (entries, exits, risk).
- Lessons and progress so users can follow a path and track what they’ve learned.

The LLM may include a short CTA or the site URL when it fits; the final tweet is truncated to 280 characters before posting. If the LLM fails or returns empty, a fallback template is used (promo + optional top headline) so a tweet is still posted.
